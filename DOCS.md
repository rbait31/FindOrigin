# Документация FindOrigin

Справочник по настройке, запуску и типичным вопросам.

---

## 1. Назначение и стек

**FindOrigin** — Telegram-бот для поиска источников информации. Пользователь присылает текст или ссылку; бот находит кандидатов (официальные сайты, новости, блоги, исследования) и с помощью AI выбирает 1–3 лучших по смыслу с оценкой уверенности.

- **Стек:** Next.js (App Router), TypeScript  
- **Поиск:** serpstack.com  
- **AI:** OpenAI (gpt-4o-mini)

---

## 2. Переменные окружения

См. файл `.env.example`. Основные переменные:

| Переменная | Назначение |
|------------|------------|
| `BOT_TOKEN` или `TELEGRAM_BOT_TOKEN` | Токен бота от @BotFather. Обязательно для ответов в Telegram. |
| `SERPSTACK_ACCESS_KEY` | Ключ с https://serpstack.com — для поиска источников. |
| `OPENAI_API_KEY` | Ключ с https://platform.openai.com/api-keys — для выбора лучших источников по смыслу. |

В `.env` или `.env.local` не должно быть пробелов вокруг `=`, например: `BOT_TOKEN=123456:ABC...`

---

## 3. Локальный запуск

```powershell
cd C:\Work\FindOrigin
npm install
npm run dev
```

Приложение будет доступно по адресу http://localhost:3000. Чтобы бот получал сообщения из Telegram, нужен **публичный URL** (см. раздел 4).

---

## 4. Webhook с локальным сервером

Чтобы Telegram доставлял обновления на ваш компьютер, нужен **туннель**: он даёт временный HTTPS-URL, который указывает на ваш localhost. Без туннеля Telegram не может «достучаться» до вашего сервера.

### 4.1. Зачем нужен туннель

Telegram при использовании webhook **сам отправляет POST-запросы** на указанный вами URL. Локальный сервер (`http://localhost:3000`) доступен только с вашего компьютера. Сервера Telegram в интернете не могут обратиться к `localhost`. Туннель (ngrok, localtunnel и т.п.) создаёт **внешний HTTPS-адрес**, который перенаправляет запросы на ваш порт 3000.

### 4.2. Варианты туннеля

- **localtunnel** — без регистрации: `npx localtunnel --port 3000`. URL вида `https://xxxx.loca.lt`. Часто бывают 503 и обрывы; URL меняется при каждом запуске.
- **ngrok** — нужна регистрация и authtoken; обычно стабильнее. Команда: `ngrok http 3000`. На практике может оказаться наоборот — зависит от сети и региона.

Туннель должен **постоянно работать** в отдельном окне. Если процесс завершился, запросы от Telegram до вашего приложения не дойдут.

### 4.3. Запуск туннеля (localtunnel)

**Вариант А — скрипт (рекомендуется)**

Скрипт открывает новое окно, в котором туннель остаётся запущенным:

```powershell
cd C:\Work\FindOrigin
.\scripts\start-tunnel.ps1
```

В открывшемся окне будет строка вида `your url is: https://xxxx.loca.lt`. **Не закрывайте это окно.** Скопируйте URL.

**Вариант Б — вручную**

В отдельном окне PowerShell:

```powershell
npx localtunnel --port 3000
```

Дождитесь строки `your url is: https://....loca.lt` и оставьте окно открытым.

### 4.4. Регистрация webhook у Telegram

Используется метод Bot API **setWebhook**. Вы **один раз** указываете Telegram URL, на который слать обновления.

**Важно:** в URL обязательно указывать **параметр `url=`** (с именем параметра). Иначе webhook не установится.

Правильная команда (подставьте свой токен бота и URL из туннеля):

```powershell
$url = "https://ВАШ-URL-ИЗ-ТУННЕЛЯ.loca.lt/api/webhook"
Invoke-RestMethod -Uri "https://api.telegram.org/botВАШ_ТОКЕН/setWebhook?url=$url"
```

Пример с реальным URL туннеля:

```powershell
$url = "https://modern-baboons-remain.loca.lt/api/webhook"
Invoke-RestMethod -Uri "https://api.telegram.org/bot8218751307:AAH.../setWebhook?url=$url"
```

- В адресе должен быть **полный домен** туннеля (например для localtunnel — **`.loca.lt`**). Ошибка «Failed to resolve host» часто из‑за опечатки или пропуска `.loca.lt`.
- Путь всегда заканчивается на **`/api/webhook`**.

### 4.5. Проверка текущего webhook

Узнать, на какой URL сейчас настроен webhook:

```powershell
Invoke-RestMethod -Uri "https://api.telegram.org/botВАШ_ТОКЕН/getWebhookInfo"
```

В ответе смотрите поле `result.url` — там должен быть ваш актуальный адрес туннеля с путём `/api/webhook`. Если вы перезапустили localtunnel, URL изменился — нужно снова вызвать setWebhook с новым URL.

### 4.6. Проверка, что туннель и сервер работают

1. **Сервер:** в браузере или PowerShell: `Invoke-RestMethod -Uri "http://localhost:3000" -Method Get` — должен вернуть ответ (не «Connection refused»).
2. **Туннель:** откройте в браузере или выполните (подставьте свой URL из окна туннеля):
   ```powershell
   Invoke-RestMethod -Uri "https://ВАШ-URL.loca.lt/api/webhook" -Method Get
   ```
   Должен вернуться JSON с сообщением «FindOrigin webhook доступен». Если **503 - Tunnel Unavailable** — туннель не работает (процесс завершился или сервис недоступен). Перезапустите туннель и при необходимости снова вызовите setWebhook с новым URL.
3. **Лог в консоли:** при отправке сообщения боту в терминале с `npm run dev` должна появляться строка `[webhook] Получено сообщение, chatId: ...`. Если её нет — запросы не доходят (неверный или мёртвый туннель, неверный webhook).

### 4.7. Типичные ошибки

| Ситуация | Причина | Что сделать |
|----------|---------|-------------|
| «Failed to resolve host» при setWebhook | В URL пропущен домен (например `.loca.lt`) или опечатка. | Проверить URL из окна туннеля и снова вызвать setWebhook с полным адресом, включая `/api/webhook`. |
| «Webhook is already deleted» | В запросе к API не указан параметр `url=` (написано `?https://...` вместо `?url=https://...`). | Использовать `setWebhook?url=$url` (с именем параметра `url`). |
| Бот не отвечает, в консоли нет лога | Туннель не запущен или URL поменялся после перезапуска; webhook указывает на старый адрес. | Запустить туннель, взять из вывода актуальный URL, вызвать setWebhook с этим URL, не закрывать окно туннеля. |
| 503 при обращении к `*.loca.lt` | Localtunnel нестабилен или процесс туннеля завершился. | Перезапустить туннель; при повторяющихся 503 рассмотреть другой туннель или деплой на Vercel. |

### 4.8. Отключение туннеля при переходе на Vercel

Отключать что‑то в коде не нужно. Туннель — это отдельная программа. После деплоя на Vercel вы просто перестаёте запускать ngrok/localtunnel и один раз вызываете setWebhook с URL приложения на Vercel. Telegram начнёт слать обновления на Vercel вместо туннеля.

---

## 5. Проверка поиска (serpstack)

Консольный скрипт для проверки поискового сервиса без Telegram:

```powershell
npm run test-search
```

Появится запрос «Введи текст для поиска:». Введите запрос и нажмите Enter — в консоль выведутся результаты поиска. Ключ берётся из `.env` / `.env.local` (`SERPSTACK_ACCESS_KEY`).

---

## 6. Ограничения и сообщения об ошибках

- **serpstack 429 (rate limit):** превышен лимит запросов по тарифу. Бот отправит сообщение о лимите и предложит попробовать позже или обновить тариф на serpstack.com. На каждое сообщение пользователю выполняется несколько запросов к API.
- **OpenAI 429 (insufficient_quota):** исчерпана квота/баланс OpenAI. Бот покажет все найденные кандидаты без выбора лучших по смыслу и подскажет проверить план и биллинг на platform.openai.com.

---

## 7. Деплой на Vercel

Пошаговая инструкция по выкладке на Vercel, настройке переменных окружения и webhook: **[DEPLOY.md](DEPLOY.md)**.

После деплоя туннель для приёма сообщений не нужен — используется постоянный HTTPS-URL приложения на Vercel.

---

## 8. Устранение неполадок

- **Бот на Vercel не отвечает, нет даже «Обрабатываю…»**  
  На Vercel обработка webhook выполняется с `await`: ответ 200 возвращается после отправки ответа пользователю. Убедитесь, что сделан последний деплой с этими изменениями. Проверьте переменные окружения (в т.ч. `BOT_TOKEN` / `TELEGRAM_BOT_TOKEN`) и логи в панели Vercel (Deployments → Logs).

- **Проверка доступности Vercel:**  
  Откройте в браузере `https://ваш-проект.vercel.app/api/webhook` — должен вернуться JSON с сообщением о доступности webhook.

- Остальные пункты по Vercel и webhook — в разделе «Если Vercel не отвечает» в **[DEPLOY.md](DEPLOY.md)**.
