# План реализации FindOrigin

Поэтапный порядок действий по реализации Telegram-бота FindOrigin на основании PROJECT.md.

---

## Этап 1. Инициализация проекта

- [x] Создать Next.js-приложение (App Router).
- [x] Настроить структуру папок: `app/api/`, утилиты, типы.
- [x] Добавить зависимости: для Telegram API, поиска, работы с AI (по выбранному провайдеру).
- [x] Описать переменные окружения: `TELEGRAM_BOT_TOKEN`, ключи для поиска и AI, при необходимости `VERCEL_URL` для webhook.

---

## Этап 2. Webhook-обработчик Telegram

- [x] Реализовать API-маршрут `POST /api/webhook` (или `/api/telegram/webhook`).
- [x] В обработчике:
  - парсить тело запроса как Telegram Update;
  - извлекать `chat.id` и `text` из `update.message` (и при необходимости `message.entities` для ссылок);
  - валидировать запрос (опционально: проверка секрета webhook).
- [x] Сразу возвращать **200 OK** без долгих операций.
- [x] Вынести отправку ответа пользователю и всю тяжёлую логику в асинхронную обработку (очередь, фоновая задача, отдельный вызов после 200).

---

## Этап 3. Получение и извлечение текста

- [x] Реализовать модуль ввода:
  - если пользователь прислал **текст** — использовать его как есть;
  - если прислал **ссылку на Telegram-пост** (t.me/…) — извлекать текст поста через Telegram API (getUpdates или Bot API для пересланных сообщений/источников, с учётом ограничений API).
- [x] Нормализовать текст: обрезка лишних пробелов, базовая очистка.

---

## Этап 4. Анализ текста и выделение сущностей

- [x] Реализовать выделение из текста:
  - ключевых утверждений (факты, тезисы);
  - дат;
  - чисел;
  - имён (персоны, организации);
  - ссылок.
- [x] Вынести логику в отдельный модуль/сервис; на выходе — структурированные данные для этапа поиска.

---

## Этап 5. Поиск возможных источников

- [x] Выбрать и подключить способ поиска (поисковая API или скрапинг в рамках правил использования).
- [x] Реализовать поиск по категориям:
  - официальные сайты;
  - новостные сайты;
  - блоги;
  - исследования (научные/аналитические источники).
- [x] Собирать кандидатов (URL + заголовок/сниппет) для передачи на этап сравнения; ограничить объём (например, топ-N по каждой категории).

---

## Этап 6. Сравнение с помощью AI и формирование ответа

- [ ] Подготовить промпт для AI: исходный текст/утверждения + список кандидатов-источников.
- [ ] Запросить у модели сравнение **по смыслу** (не буквальное совпадение текста).
- [ ] Парсить ответ AI: отобрать 1–3 лучших источника и оценку уверенности (например, проценты или уровни).
- [ ] Сформировать текст ответа пользователю: список ссылок + краткая оценка уверенности.

---

## Этап 7. Отправка ответа пользователю

- [ ] В асинхронном обработчике после этапов 3–6 вызвать Telegram API `sendMessage` (chat_id, сформированный текст).
- [ ] Обработать ошибки (повтор, логирование, уведомление пользователю при сбое).
- [ ] При длительной обработке рассмотреть уведомление «Ищу источники…» сразу после 200 OK.

---

## Этап 8. Конфигурация и деплой

- [ ] Настроить webhook Telegram на URL Vercel: `https://<VERCEL_URL>/api/webhook` через `setWebhook`.
- [ ] Добавить в Vercel переменные окружения (токен бота, ключи API).
- [ ] Проверить лимиты Vercel (таймауты функций) и при необходимости вынести долгие задачи в фоновые/очередь.
- [ ] Написать краткую инструкцию по запуску и настройке webhook в README или отдельном файле.

---

## Порядок выполнения (кратко)

1. Инициализация проекта и окружения.  
2. Webhook: принять POST, извлечь chat.id и text, сразу вернуть 200.  
3. Получение текста: из сообщения или из ссылки на пост.  
4. Выделение сущностей (утверждения, даты, числа, имена, ссылки).  
5. Поиск источников по категориям.  
6. AI: сравнение по смыслу, выбор 1–3 источников и оценка уверенности.  
7. Отправка ответа через sendMessage.  
8. Деплой на Vercel и настройка webhook.

После каждого этапа имеет смысл проверять работу по шагам (локально или на тестовом боте), чтобы изолировать ошибки.
